name: Release (on tag)

on:
  push:
    tags: [ 'v*.*.*' ]

permissions:
  contents: read

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Sanity cleanup (legacy wiki dir)
        run: |
          rm -rf .wiki-publish || true

      - name: Ensure local API image tag exists
        run: |
          set -e
          IMAGE_LOCAL="docker-api:latest"
          IMAGE_TARGET="ghcr.io/freehekimteam/freehekim-rag-api:dev"
          if ! docker image inspect "$IMAGE_TARGET" >/dev/null 2>&1; then
            if docker image inspect "$IMAGE_LOCAL" >/dev/null 2>&1; then
              echo "Tagging $IMAGE_LOCAL -> $IMAGE_TARGET"
              docker tag "$IMAGE_LOCAL" "$IMAGE_TARGET"
            else
              echo "Local image $IMAGE_LOCAL not found; relying on registry pull (may fail if private)"
            fi
          fi

      - name: Docker Compose Up
        run: |
          set -x
          docker compose -f deployment/docker/docker-compose.server.yml pull || true
          docker compose -f deployment/docker/docker-compose.server.yml up -d
