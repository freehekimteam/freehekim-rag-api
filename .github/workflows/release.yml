name: Release (on tag)

on:
  push:
    tags: [ 'v*.*.*' ]

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: [self-hosted, linux]
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          clean: true

      - name: Sanity cleanup (legacy wiki dir)
        run: |
          rm -rf .wiki-publish || true

      - name: Ensure local API image tag exists
        run: |
          set -e
          IMAGE_LOCAL="docker-api:latest"
          IMAGE_TARGET="ghcr.io/freehekimteam/freehekim-rag-api:dev"
          if ! docker image inspect "$IMAGE_TARGET" >/dev/null 2>&1; then
            if docker image inspect "$IMAGE_LOCAL" >/dev/null 2>&1; then
              echo "Tagging $IMAGE_LOCAL -> $IMAGE_TARGET"
              docker tag "$IMAGE_LOCAL" "$IMAGE_TARGET"
            else
              echo "Local image $IMAGE_LOCAL not found; relying on registry pull (may fail if private)"
            fi
          fi

      - name: Docker Compose Up
        run: |
          set -x
          docker compose -f deployment/docker/docker-compose.server.yml pull || true
          docker compose -f deployment/docker/docker-compose.server.yml up -d
      - name: GHCR Login (using GITHUB_TOKEN)
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push image to GHCR
        run: |
          set -e
          IMAGE="ghcr.io/${{ github.repository }}:${GITHUB_REF_NAME}"
          IMAGE_DEV="ghcr.io/${{ github.repository }}:dev"
          docker build -f deployment/docker/Dockerfile.api -t "$IMAGE" -t "$IMAGE_DEV" .
          docker push "$IMAGE"
          docker push "$IMAGE_DEV"
